---
import BaseLayout from '../layouts/BaseLayout.astro';
import { readdir } from 'fs/promises';
import { join } from 'path';

const title = 'Components';

// Function to recursively get all component files
async function getComponents(dir: string, basePath: string = ''): Promise<Array<{name: string, path: string, type: string}>> {
  const components: Array<{name: string, path: string, type: string}> = [];
  
  try {
    const entries = await readdir(dir, { withFileTypes: true });
    
    for (const entry of entries) {
      const fullPath = join(dir, entry.name);
      const relativePath = basePath ? `${basePath}/${entry.name}` : entry.name;
      
      if (entry.isDirectory()) {
        // Recursively search subdirectories
        const subComponents = await getComponents(fullPath, relativePath);
        components.push(...subComponents);
      } else if (entry.isFile()) {
        // Check if it's a component file
        if (entry.name.endsWith('.astro') || entry.name.endsWith('.tsx')) {
          const type = entry.name.endsWith('.astro') ? 'Astro' : 'React (TSX)';
          const name = entry.name.replace(/\.(astro|tsx)$/, '');
          components.push({
            name,
            path: relativePath,
            type
          });
        }
      }
    }
  } catch (error) {
    console.error('Error reading components directory:', error);
  }
  
  return components;
}

// Get components from the components directory
const componentsDir = join(process.cwd(), 'src', 'components');
const allComponents = await getComponents(componentsDir);

// Sort components by type, then by name
allComponents.sort((a, b) => {
  if (a.type !== b.type) {
    return a.type.localeCompare(b.type);
  }
  return a.name.localeCompare(b.name);
});

// Group components by type
const componentsByType = allComponents.reduce((acc, component) => {
  if (!acc[component.type]) {
    acc[component.type] = [];
  }
  acc[component.type].push(component);
  return acc;
}, {} as Record<string, typeof allComponents>);
---

<BaseLayout title={title}>
  <div style="max-width: 800px; margin: 0 auto; padding: 1rem;">
    <h1>Components</h1>
    <p style="margin-bottom: 2rem; color: #666;">
      This page lists all the components used throughout the site. 
      Total: <strong>{allComponents.length} components</strong>
    </p>

    {Object.entries(componentsByType).map(([type, components]) => (
      <section style="margin-bottom: 2rem;">
        <h2 style="border-bottom: 2px solid #eee; padding-bottom: 0.5rem; margin-bottom: 1rem;">
          {type} Components ({components.length})
        </h2>
        <div style="display: grid; gap: 0.75rem;">
          {components.map(component => (
            <div style="
              border: 1px solid #e0e0e0; 
              border-radius: 6px; 
              padding: 1rem;
              background: #fafafa;
              transition: all 0.2s ease;
              cursor: pointer;
            " 
            onmouseover="this.style.backgroundColor='#f0f0f0'; this.style.borderColor='#ccc'"
            onmouseout="this.style.backgroundColor='#fafafa'; this.style.borderColor='#e0e0e0'">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; font-size: 1.1rem; color: #333;">
                  {component.name}
                </h3>
                <code style="
                  background: #e8e8e8; 
                  padding: 0.25rem 0.5rem; 
                  border-radius: 3px; 
                  font-size: 0.75rem;
                  color: #555;
                ">
                  {component.type}
                </code>
              </div>
              <p style="
                margin: 0.5rem 0 0 0; 
                font-size: 0.875rem; 
                color: #666; 
                font-family: monospace;
              ">
                src/components/{component.path}
              </p>
            </div>
          ))}
        </div>
      </section>
    ))}
  </div>
</BaseLayout>